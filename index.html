<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рж╢рзБржн рзнрзпрждржо рж╕рзНржмрж╛ржзрзАржирждрж╛ ржжрж┐ржмрж╕!</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for audio generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Noto Sans Bengali and Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+Bengali:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Use the Noto Sans Bengali font family with Inter as a fallback */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: 'Noto Sans Bengali', 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Custom gradient using the Indian flag colors */
        .tricolor-gradient {
            background: linear-gradient(180deg, #FF9933 0%, #FFFFFF 50%, #138808 100%);
        }
        /* Ashok Chakra inspired SVG */
        .ashok-chakra {
            animation: spin 20s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        /* Canvas for confetti effect */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Behind modal, above content */
            pointer-events: none; /* Make canvas unclickable */
        }
        /* Ensure content is above the canvas */
        .content-wrapper {
            position: relative;
            z-index: 2;
        }
        /* Modal styles */
        #name-modal, #horoscope-modal, #qa-modal {
            z-index: 10;
        }
        /* Disabled button style */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="tricolor-gradient p-2 sm:p-4">

    <canvas id="confetti-canvas"></canvas>

    <!-- Name Input Modal -->
    <div id="name-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 text-center w-11/12 max-w-sm">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">рж╢рзБржн рж╕рзНржмрж╛ржзрзАржирждрж╛ ржжрж┐ржмрж╕!</h2>
            <p class="mb-6 text-gray-600 text-sm sm:text-base">ржмрзНржпржХрзНрждрж┐ржЧржд рж╢рзБржнрзЗржЪрзНржЫрж╛ ржкрзЗрждрзЗ ржЖржкржирж╛рж░ ржирж╛ржо рж▓рж┐ржЦрзБржиред</p>
            <input type="text" id="name-input" placeholder="ржЖржкржирж╛рж░ ржирж╛ржо" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="submit-name-button" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                ржЖржорж╛рж░ рж╢рзБржнрзЗржЪрзНржЫрж╛ ржкрж╛ржи
            </button>
        </div>
    </div>
    
    <!-- Horoscope Input Modal -->
    <div id="horoscope-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 text-center w-11/12 max-w-sm">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">ржЖржкржирж╛рж░ рж░рж╛рж╢рж┐ржлрж▓ ржЬрж╛ржирзБржи</h2>
            <p class="mb-6 text-gray-600 text-sm sm:text-base">ржЖржкржирж╛рж░ ржЬржирзНржорждрж╛рж░рж┐ржЦ ржжрж┐ржиред</p>
            <input type="date" id="dob-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="submit-horoscope-button" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                рж░рж╛рж╢рж┐ржлрж▓ ржкрж╛ржи
            </button>
             <button id="close-horoscope-modal" class="w-full mt-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ржмржирзНржз ржХрж░рзБржи</button>
        </div>
    </div>
    
    <!-- Q&A Input Modal -->
    <div id="qa-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 text-center w-11/12 max-w-sm">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800">Your AI Assistant</h2>
            <p class="mb-2 text-gray-600 text-sm sm:text-base">ржЖржкржирж╛рж░ ржкрзНрж░рж╢рзНржи ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзБржиред</p>
            <textarea id="qa-input" placeholder="ржЖржкржирж╛рж░ ржкрзНрж░рж╢рзНржи ржПржЦрж╛ржирзЗ рж▓рж┐ржЦрзБржи ржЕржержмрж╛ ржорж╛ржЗржХрзНрж░рзЛржлрзЛржирзЗ ржмрж▓рзБржи..." rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <div class="flex items-center gap-2 mb-4">
                <button id="start-recognition-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-3 rounded-full transition-transform transform hover:scale-110">
                    ЁЯОд
                </button>
                <p id="recognition-status" class="text-sm text-gray-500 flex-grow text-left"></p>
            </div>
            <button id="submit-qa-button" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">
                ржкрзНрж░рж╢рзНржи ржЬржорж╛ ржжрж┐ржи
            </button>
            <button id="close-qa-modal" class="w-full mt-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ржмржирзНржз ржХрж░рзБржи</button>
        </div>
    </div>


    <div id="main-content" class="content-wrapper w-full max-w-4xl mx-auto bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-4 md:p-6 text-center text-gray-800 overflow-y-auto hidden max-h-full">

        <!-- Header Section -->
        <header class="relative mb-4 sm:mb-6">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-10 w-40 h-40 sm:w-56 sm:h-56">
                <svg class="ashok-chakra" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#000080" stroke-width="2"/>
                    <circle cx="50" cy="50" r="5" fill="#000080"/>
                    <g stroke="#000080" stroke-width="1"><path d="M50 5 L50 95" /><path d="M5 50 L95 50" /><path d="M14.6 14.6 L85.4 85.4" /><path d="M14.6 85.4 L85.4 14.6" /><path d="M29.3 7.7 L70.7 92.3" /><path d="M7.7 29.3 L92.3 70.7" /><path d="M7.7 70.7 L92.3 29.3" /><path d="M29.3 92.3 L70.7 7.7" /><path d="M50 5 a 45 45 0 0 1 35.3 17.6 l -3.5 -6.1" /><path d="M50 5 a 45 45 0 0 1 43.3 35.3 l -6.1 -3.5" /><path d="M50 95 a 45 45 0 0 1 -35.3 -17.6 l 3.5 6.1" /><path d="M50 95 a 45 45 0 0 1 -43.3 -35.3 l 6.1 3.5" /><path d="M95 50 a 45 45 0 0 1 -17.6 35.3 l -6.1 -3.5" /><path d="M95 50 a 45 45 0 0 1 -35.3 43.3 l -3.5 -6.1" /><path d="M5 50 a 45 45 0 0 1 17.6 -35.3 l 6.1 3.5" /><path d="M5 50 a 45 45 0 0 1 35.3 -43.3 l 3.5 6.1" /></g>
                </svg>
            </div>
            <h1 id="main-greeting" class="text-2xl sm:text-3xl md:text-5xl font-black text-orange-600 tracking-tight"></h1>
            <p class="text-sm sm:text-base md:text-lg mt-2 text-blue-800 font-semibold">рж╕рзНржмрж╛ржзрзАржирждрж╛, ржПржХрждрж╛ ржПржмржВ ржЕржЧрзНрж░ржЧрждрж┐рж░ ржЙржжржпрж╛ржкржи</p>
        </header>

        <!-- Greetings Section -->
        <main class="space-y-3 sm:space-y-4">
            <div class="p-3 sm:p-4 bg-orange-100/50 rounded-lg transition-transform transform hover:-translate-y-1"><p class="text-xs sm:text-base">"ржоржирзЗ рж╕рзНржмрж╛ржзрзАржирждрж╛, ржХржерж╛ржпрж╝ ржмрж┐рж╢рзНржмрж╛рж╕, ржЖрждрзНржорж╛ржпрж╝ ржЧрж░рзНржмред ржЖрж╕рзБржи ржПржЗ рж╢рзБржн ржжрж┐ржирзЗ ржЬрж╛рждрж┐ржХрзЗ рж╕рзНржпрж╛рж▓рзБржЯ ржЬрж╛ржирж╛ржЗред ржЬржпрж╝ рж╣рж┐ржирзНржж!"</p></div>
            <div class="p-3 sm:p-4 bg-green-100/50 rounded-lg transition-transform transform hover:-translate-y-1"><p class="text-xs sm:text-base">"ржнрж╛рж░рждрзЗрж░ рждрзЗрж░ржЩрзНржЧрж╛ ржпрзЗржи рж╕рж░рзНржмржжрж╛ ржЙржБржЪрзБрждрзЗ ржУржбрж╝рзЗред рж╕рзНржмрж╛ржзрзАржирждрж╛ ржжрж┐ржмрж╕рзЗрж░ ржПржЗ ржорж╣рж╛ржи ржЕржирзБрж╖рзНржарж╛ржирзЗ ржЖржирзНрждрж░рж┐ржХ рж╢рзБржнрзЗржЪрзНржЫрж╛ред"</p></div>
            <div class="p-3 sm:p-4 bg-blue-100/50 rounded-lg transition-transform transform hover:-translate-y-1"><p class="text-xs sm:text-base">"ржПржЗ ржжрж┐ржирзЗ, ржЖрж╕рзБржи ржЖржорж░рж╛ ржЖржорж╛ржжрзЗрж░ ржорзБржХрзНрждрж┐ржпрзЛржжрзНржзрж╛ржжрзЗрж░ ржЖрждрзНржорждрзНржпрж╛ржЧ рж╕рзНржорж░ржг ржХрж░рж┐ ржПржмржВ ржПржоржи ржПржХржЯрж┐ ржнрж╛рж░ржд ржЧржбрж╝рж╛рж░ рж╢ржкрже ржХрж░рж┐ ржпрж╛ ржирж┐ржпрж╝рзЗ рждрж╛рж░рж╛ ржЧрж░рзНржмрж┐ржд рж╣ржмрзЗред"</p></div>
        </main>

        <!-- Control Section -->
        <footer class="mt-4 sm:mt-6">
            <div class="flex flex-wrap items-center justify-center gap-3 sm:gap-4">
                <button id="music-button" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 w-full sm:w-auto text-sm sm:text-base">ржжрзЗрж╢рж╛рждрзНржоржмрзЛржзржХ рж╕ржЩрзНржЧрзАржд ржЪрж╛рж▓рж╛ржи</button>
                <button id="gemini-talk-button" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 w-full sm:w-auto text-sm sm:text-base font-sans">Message from Kanan</button>
                <button id="horoscope-button" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 w-full sm:w-auto text-sm sm:text-base">ржЖржЬржХрзЗрж░ рж░рж╛рж╢рж┐ржлрж▓</button>
                <button id="ai-assistant-button" class="bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-2 px-5 sm:py-3 sm:px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 w-full sm:w-auto text-sm sm:text-base font-sans">AI Assistant</button>
            </div>
            <div id="gemini-status" class="text-xs sm:text-sm text-gray-600 mt-2 h-5"></div>
        </footer>
        
        <!-- Developer Info Footer -->
        <footer class="mt-4 sm:mt-6 border-t pt-4 text-gray-600 font-sans">
            <div class="flex flex-col items-center text-center space-y-2">
                <p class="font-bold text-lg sm:text-xl text-gray-800">Kanan Pandit</p>
                <p class="text-xs sm:text-sm italic">Aspiring Data Scientist & AI Enthusiast</p>
                <div class="flex flex-wrap justify-center items-center space-x-3 sm:space-x-5 text-sm sm:text-base">
                    <a href="https://kananpanditportfolio.netlify.app" target="_blank" class="flex items-center space-x-1 hover:text-blue-700"><span>ЁЯМР</span> <span>Portfolio</span></a>
                    <a href="https://www.linkedin.com/in/kananpandit02" target="_blank" class="flex items-center space-x-1 hover:text-blue-700"><span>ЁЯФЧ</span> <span>LinkedIn</span></a>
                    <a href="https://github.com/kananpandit02" target="_blank" class="flex items-center space-x-1 hover:text-blue-700"><span>ЁЯТ╗</span> <span>GitHub</span></a>
                </div>
                <div class="text-xs sm:text-sm space-y-1">
                    <p>ЁЯУз Email: <a href="mailto:kananpandit02@gmail.com" class="hover:underline">kananpandit02@gmail.com</a></p>
                    <p>ЁЯУ▒ Phone: <a href="tel:+917384661310" class="hover:underline">+91 7384661310</a></p>
                </div>
                <p class="text-xs mt-2">Made with тЭдя╕П by <span class="font-semibold">Kanan Pandit</span></p>
            </div>
        </footer>

    </div>

    <script>
        // --- DOM Elements ---
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        const submitNameButton = document.getElementById('submit-name-button');
        const mainContent = document.getElementById('main-content');
        const mainGreeting = document.getElementById('main-greeting');
        const musicButton = document.getElementById('music-button');
        const geminiTalkButton = document.getElementById('gemini-talk-button');
        const geminiStatus = document.getElementById('gemini-status');
        const horoscopeButton = document.getElementById('horoscope-button');
        const horoscopeModal = document.getElementById('horoscope-modal');
        const dobInput = document.getElementById('dob-input');
        const submitHoroscopeButton = document.getElementById('submit-horoscope-button');
        const closeHoroscopeModalButton = document.getElementById('close-horoscope-modal');
        const aiAssistantButton = document.getElementById('ai-assistant-button');
        const qaModal = document.getElementById('qa-modal');
        const qaInput = document.getElementById('qa-input');
        const submitQaButton = document.getElementById('submit-qa-button');
        const closeQaModalButton = document.getElementById('close-qa-modal');
        const startRecognitionButton = document.getElementById('start-recognition-button');
        const recognitionStatus = document.getElementById('recognition-status');
        
        // --- Personalization Logic ---
        function showPersonalizedView(name) {
            mainGreeting.textContent = `рж╢рзБржн рж╕рзНржмрж╛ржзрзАржирждрж╛ ржжрж┐ржмрж╕, ${name}!`;
            nameModal.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }

        submitNameButton.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                localStorage.setItem('visitorName', name);
                showPersonalizedView(name);
            } else {
                nameInput.placeholder = "ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржПржХржЯрж┐ ржирж╛ржо рж▓рж┐ржЦрзБржи!";
                nameInput.classList.add('border-red-500');
            }
        });
        
        nameInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') submitNameButton.click(); });

        window.addEventListener('load', () => {
            const savedName = localStorage.getItem('visitorName');
            if (savedName) showPersonalizedView(savedName);
            else nameModal.classList.remove('hidden');
        });

        // --- Music & Voice Logic ---
        let musicPlaying = false;
        const synth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const melody = [ { time: '0:0', note: 'E4', duration: '8n' }, { time: '0:0:2', note: 'F#4', duration: '8n' }, { time: '0:1', note: 'G4', duration: '4n' }, { time: '0:2', note: 'G4', duration: '8n' }, { time: '0:2:2', note: 'G4', duration: '8n' }, { time: '0:3', note: 'G4', duration: '4n' }, { time: '1:0', note: 'G4', duration: '8n' }, { time: '1:0:2', note: 'F#4', duration: '8n' }, { time: '1:1', note: 'E4', duration: '4n' }, { time: '1:2', note: 'D4', duration: '4n' }, { time: '1:3', note: 'E4', duration: '4n' }, { time: '2:0', note: 'E4', duration: '8n' }, { time: '2:0:2', note: 'F#4', duration: '8n' }, { time: '2:1', note: 'G4', duration: '4n' }, { time: '2:2', note: 'G4', duration: '8n' }, { time: '2:2:2', note: 'G4', duration: '8n' }, { time: '2:3', note: 'G4', duration: '4n' }, { time: '3:0', note: 'A4', duration: '4n' }, { time: '3:1', note: 'B4', duration: '4n' }, { time: '3:2', note: 'A4', duration: '4n' }, { time: '3:3', note: 'G4', duration: '4n' }, { time: '4:0', note: 'C5', duration: '4n' }, { time: '4:1', note: 'C5', duration: '4n' }, { time: '4:2', note: 'B4', duration: '4n' }, { time: '4:3', note: 'A4', duration: '4n' }, { time: '5:0', note: 'G4', duration: '2n' }, { time: '5:2', note: 'A4', duration: '2n' }, { time: '6:0', note: 'B4', duration: '4n' }, { time: '6:1', note: 'B4', duration: '4n' }, { time: '6:2', note: 'A4', duration: '4n' }, { time: '6:3', note: 'G4', duration: '4n' }, { time: '7:0', note: 'F#4', duration: '2n' }, { time: '7:2', note: 'G4', duration: '2n' } ];
        const part = new Tone.Part((time, value) => { synth.triggerAttackRelease(value.note, value.duration, time); }, melody).start(0);
        part.loop = true; part.loopStart = 0; part.loopEnd = '8m';

        musicButton.addEventListener('click', async () => {
            if (Tone.context.state !== 'running') await Tone.start();
            if (!musicPlaying) {
                Tone.Transport.start();
                musicButton.textContent = 'рж╕ржЩрзНржЧрзАржд ржЪрж▓ржЫрзЗ...';
                musicButton.classList.replace('bg-blue-700', 'bg-green-600');
                musicButton.classList.replace('hover:bg-blue-800', 'hover:bg-green-700');
                musicPlaying = true;
            } else {
                Tone.Transport.stop();
                musicButton.textContent = 'ржжрзЗрж╢рж╛рждрзНржоржмрзЛржзржХ рж╕ржЩрзНржЧрзАржд ржЪрж╛рж▓рж╛ржи';
                musicButton.classList.replace('bg-green-600', 'bg-blue-700');
                musicButton.classList.replace('hover:bg-green-700', 'hover:bg-blue-800');
                musicPlaying = false;
            }
        });

        // --- Gemini TTS and Text Generation ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64); const len = binaryString.length; const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); } return bytes.buffer;
        }
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1; const bitsPerSample = 16; const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign; const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize); const view = new DataView(buffer);
            view.setUint32(0, 0x52494646, false); view.setUint32(4, 36 + dataSize, true); view.setUint32(8, 0x57415645, false);
            view.setUint32(12, 0x666d7420, false); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); view.setUint32(36, 0x64617461, false);
            view.setUint32(40, dataSize, true); let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) { view.setInt16(offset, pcmData[i], true); }
            return new Blob([view], { type: 'audio/wav' });
        }

        async function getAndSpeak(textGenPrompt) {
            let wasMusicPlaying = musicPlaying;
            const allButtons = [geminiTalkButton, musicButton, horoscopeButton, aiAssistantButton];
            allButtons.forEach(btn => btn.disabled = true);
            if (wasMusicPlaying) { Tone.Transport.pause(); }

            try {
                geminiStatus.textContent = 'ржмрж╛рж░рзНрждрж╛ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...';
                let textPayload = { contents: [{ role: "user", parts: [{ text: textGenPrompt }] }] };
                const apiKey = "AIzaSyBaKzXWuh240jWKbS7Cfv7GInT-z1D4wvo";
                let textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                let response = await fetch(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(textPayload) });
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => response.text());
                    throw new Error(`Text generation failed: ${JSON.stringify(errorBody)}`);
                }
                let result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!generatedText) throw new Error("Could not get text from Gemini.");

                geminiStatus.textContent = 'ржЕржбрж┐ржУ рждрзИрж░рж┐ рж╣ржЪрзНржЫрзЗ...';
                const ttsPrompt = generatedText; 
                let ttsPayload = { contents: [{ parts: [{ text: ttsPrompt }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }, model: "gemini-2.5-flash-preview-tts" };
                let ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                response = await fetch(ttsApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ttsPayload) });
                if (!response.ok) {
                     const errorBody = await response.json().catch(() => response.text());
                    throw new Error(`TTS generation failed: ${JSON.stringify(errorBody)}`);
                }
                result = await response.json();
                
                if (!result.candidates || result.candidates.length === 0) {
                    console.error("TTS API returned no candidates. Response:", result);
                    throw new Error("Failed to generate audio from the text.");
                }

                const audioPart = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = audioPart?.inlineData?.data; 
                const mimeType = audioPart?.inlineData?.mimeType;
                if (!audioData || !mimeType || !mimeType.startsWith("audio/")) { throw new Error("Invalid audio data received."); }

                geminiStatus.textContent = 'ржмрж▓рж╛ рж╣ржЪрзНржЫрзЗ...';
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData); 
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate); 
                const audioUrl = URL.createObjectURL(wavBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                audio.onended = () => {
                    geminiStatus.textContent = '';
                    if (wasMusicPlaying) { Tone.Transport.start(); }
                    allButtons.forEach(btn => btn.disabled = false);
                };
            } catch (error) {
                console.error("Error with Gemini feature:", error);
                geminiStatus.textContent = 'ржжрзБржГржЦрж┐ржд, ржПржХржЯрж┐ рждрзНрж░рзБржЯрж┐ ржШржЯрзЗржЫрзЗред';
                setTimeout(() => {
                    geminiStatus.textContent = '';
                    if (wasMusicPlaying) Tone.Transport.start();
                    allButtons.forEach(btn => btn.disabled = false);
                }, 3000);
            }
        }

        geminiTalkButton.addEventListener('click', () => {
            const visitorName = localStorage.getItem('visitorName') || 'ржмржирзНржзрзБ';
            const prompt = `ржХрж╛ржиржи ржкржирзНржбрж┐ржд-ржПрж░ ржкржХрзНрж╖ ржерзЗржХрзЗ ${visitorName}-ржХрзЗ рж╕рзНржмрж╛ржзрзАржирждрж╛ ржжрж┐ржмрж╕рзЗрж░ ржПржХржЯрж┐ рж╕ржВржХрзНрж╖рж┐ржкрзНржд, ржмрзНржпржХрзНрждрж┐ржЧржд ржПржмржВ ржЙрзОрж╕рж╛рж╣ржмрзНржпржЮрзНржЬржХ ржмрж╛рж░рзНрждрж╛ ржжрж┐ржиред ржмрж╛рж░рзНрждрж╛ржЯрж┐рж░ рж╢рзЗрж╖рзЗ ржпрзЛржЧ ржХрж░рзБржи, 'ржЖржорж┐ ржХрж╛ржиржи ржкржирзНржбрж┐рждрзЗрж░ ржжрзНржмрж╛рж░рж╛ ржкрзНрж░рж╢рж┐ржХрзНрж╖рж┐ржд ржПржХржЬржи ржХрзГрждрзНрж░рж┐ржо рж╕рж╣ржХрж╛рж░рзАред'`;
            getAndSpeak(prompt);
        });

        // --- Horoscope Logic ---
        horoscopeButton.addEventListener('click', () => { horoscopeModal.classList.remove('hidden'); });
        closeHoroscopeModalButton.addEventListener('click', () => { horoscopeModal.classList.add('hidden'); });

        function getZodiacSign(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "ржХрзБржорзНржн";
            if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "ржорзАржи";
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "ржорзЗрж╖";
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "ржмрзГрж╖";
            if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "ржорж┐ржерзБржи";
            if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "ржХрж░рзНржХржЯ";
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "рж╕рж┐ржВрж╣";
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "ржХржирзНржпрж╛";
            if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "рждрзБрж▓рж╛";
            if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "ржмрзГрж╢рзНржЪрж┐ржХ";
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "ржзржирзБ";
            if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return "ржоржХрж░";
        }

        submitHoroscopeButton.addEventListener('click', () => {
            const dob = dobInput.value;
            if (dob) {
                const date = new Date(dob);
                const zodiacSign = getZodiacSign(date);
                horoscopeModal.classList.add('hidden');
                const visitorName = localStorage.getItem('visitorName') || 'ржмржирзНржзрзБ';
                const prompt = `ржЖржЬржХрзЗрж░ ржЬржирзНржп ${visitorName}-ржПрж░ рж░рж╛рж╢рж┐ржлрж▓ рждрзИрж░рж┐ ржХрж░рзБржи, ржпрж╛рж░ рж░рж╛рж╢рж┐ ${zodiacSign}ред ржПржЯрж┐ рж╕ржВржХрзНрж╖рж┐ржкрзНржд ржПржмржВ ржЗрждрж┐ржмрж╛ржЪржХ рж░рж╛ржЦрзБржиред`;
                getAndSpeak(prompt);
            }
        });

        // --- Q&A and Speech Recognition Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'bn-IN';
            recognition.interimResults = false;

            recognition.onstart = () => {
                recognitionStatus.textContent = 'рж╢рзБржиржЫрж┐...';
                startRecognitionButton.classList.add('bg-red-500');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                qaInput.value = transcript;
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error", event.error);
                recognitionStatus.textContent = 'ржжрзБржГржЦрж┐ржд, ржХрж┐ржЫрзБ ржнрзБрж▓ рж╣ржпрж╝рзЗржЫрзЗред';
            };

            recognition.onend = () => {
                recognitionStatus.textContent = '';
                startRecognitionButton.classList.remove('bg-red-500');
            };

            startRecognitionButton.addEventListener('click', () => {
                recognition.start();
            });

        } else {
            startRecognitionButton.disabled = true;
            recognitionStatus.textContent = "ржЖржкржирж╛рж░ ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржнржпрж╝рзЗрж╕ рж╕ржорж░рзНржержи ржХрж░рзЗ ржирж╛ред";
        }

        aiAssistantButton.addEventListener('click', () => { qaModal.classList.remove('hidden'); });
        closeQaModalButton.addEventListener('click', () => { qaModal.classList.add('hidden'); });
        submitQaButton.addEventListener('click', () => {
            const question = qaInput.value.trim();
            if (question) {
                qaModal.classList.add('hidden');
                getAndSpeak(question);
                qaInput.value = '';
            }
        });


        // --- Confetti Effect ---
        const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let confettiPieces = []; const numberOfPieces = 150; const colors = ['#FF9933', '#FFFFFF', '#138808'];
        function createConfetti() {
            confettiPieces = [];
            for (let i = 0; i < numberOfPieces; i++) { confettiPieces.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height, size: Math.random() * 8 + 5, color: colors[Math.floor(Math.random() * colors.length)], speed: Math.random() * 3 + 1, angle: Math.random() * 2 * Math.PI, spin: Math.random() < 0.5 ? -1 : 1 }); }
        }
        function updateConfetti() {
            for (let i = 0; i < confettiPieces.length; i++) {
                const p = confettiPieces[i]; p.y += p.speed; p.angle += p.spin * 0.05;
                if (p.y > canvas.height) confettiPieces[i] = { x: Math.random() * canvas.width, y: -20, size: p.size, color: p.color, speed: p.speed, angle: p.angle, spin: p.spin };
            }
        }
        function drawConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < confettiPieces.length; i++) {
                const p = confettiPieces[i]; ctx.save(); ctx.fillStyle = p.color;
                ctx.translate(p.x + p.size / 2, p.y + p.size / 2); ctx.rotate(p.angle);
                ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size); ctx.restore();
            }
        }
        function animateConfetti() { updateConfetti(); drawConfetti(); requestAnimationFrame(animateConfetti); }
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; createConfetti(); });
        createConfetti(); animateConfetti();
    </script>

</body>
</html>

